<link href="~/assets/css/form.css" rel="stylesheet" />
<input id="conversation-id" type="hidden" />
<div class="chat__info-layout">
    <div class="chat__info-general">
        <div class="chat__info-avatar">
            <div class="chat__info-avatar-border">
                <img class="object-info-avatar" src="~/assets/img/b3.jpg" />
            </div>
        </div>
        @*<div class="chat__info-name">
            Nguyễn Minh Hiếup
        </div>*@
        <h2>Nguyễn Minh Hiếu</h2>
        <div class="form-close">
            <i class="far fa-times-circle"></i>
        </div>
    </div>
</div>
<div class="chat-area">
    <section class="chatbox">
        <section class="chat-window">
            
        </section>
        
    </section>
</div>
<form class="chat-input" onsubmit="return false;">
    <input id="message-text" type="text" autocomplete="on" placeholder="Type a message" style="max-width: 100%"/>
    <button id="btnSend">
        <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="rgba(0,0,0,.38)" d="M17,12L12,17V14H8V10H12V7L17,12M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L5,8.09V15.91L12,19.85L19,15.91V8.09L12,4.15Z" /></svg>
    </button>
</form>
@*<script src="js/eventHomePage.js"></script>*@
<script>
    $(document).on('click', '.form-close', function () {
        $('.scroll-photos-area').html('')
        $.ajax({
            url: "/Velo/Photos/" + $('#id-user').val(),
        }).done(function (rs) {
            $('.scroll-photos-area').html(rs)
        }).fail(function (err) {
            console.log(err)
        })
    })

    $(function () {
        var chatHub = $.connection.chat;
        loadClient(chatHub);
        //khởi chạy connect hub
        $.connection.hub.start().done(function () {
            console.log('connected');
            //$("#btnLogin").click(function () {
            //    var name = $("#txtName").val();
            //    chatHub.server.connect(name);
            //    $('#welcome').html("Xin chao : " + name);
            //    show();
            //});

            $('#btnSend').click(function () {
                //var msg = $('#txtMessage').val();
                //var name = $('#hName').val();
                //chatHub.server.message(name, msg);
                //$('#txtMessage').val('').focus();
                var message = {
                    conversation_id: $('#conversation-id').val(),
                    user_id_sent: $('#id-user').val(),
                    message_text: $('#message-text').val()
                }
                chatHub.server.message(JSON.stringify(message));
                $('.chat-window').append(sendMessage(message))
                $('#message-text').val('')
            });
        });
    })

    // load các ham bên phía client
    function loadClient(chatHub) {
        chatHub.client.message = function (messageJSON) {
            //$('#contentMsg').append("<li><strong>" + name + "</strong>: " + msg + "</li>");
            $('.chat-window').append(receiveMessage(JSON.parse(messageJSON)))
        }
        chatHub.client.connect = function (name) {
            //$('#hName').val(name);
        }
    }

    function sendMessage(message) {
        return `<article class="msg-container msg-self" id="msg-0">
            <div class="msg-box">
                <div class="flr">
                    <div class="messages">
                        <p class="msg" id="msg-1">
                            ${message.message_text}
                        </p>
                    </div>
                    <div class="timestamp"><span class="username">Name</span>&bull;<span class="posttime">Now</span></div>
                </div>
                <img class="user-img" id="user-0" src="/assets/img/b1.jpg" />
            </div>
        </article>`
    }

    function receiveMessage(message) {
        return `<article class="msg-container msg-remote" id="msg-0">
            <div class="msg-box">
                <img class="user-img" id="user-0" src="/assets/img/b3.jpg" />
                <div class="flr">
                    <div class="messages">
                        <p class="msg" id="msg-0">
                            ${message.message_text}
                        </p>
                    </div>
                    <div class="timestamp"><span class="username">Name</span>&bull;<span class="posttime">1 minute ago</span></div>
                </div>
            </div>
        </article>`
    }
</script>
