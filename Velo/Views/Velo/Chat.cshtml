@using Velo.Models
@model  CONVERSATION

<link href="~/assets/css/form.css" rel="stylesheet" />
<input id="conversation-id" type="hidden" value="@Model.Conversation_ID" />
<div class="chat__info-layout">
    <div class="chat__info-general">
        <div class="chat__info-avatar">
            <div class="chat__info-avatar-border">
                <img class="object-info-avatar" src="@Model.CONVERSATION_DETAIL.Where(detail => (detail.ID_User != ViewBag.User_ID)).FirstOrDefault().ACCOUNT.Photos.Where(photo => photo.isAvatar == true).FirstOrDefault().Link" />
            </div>
        </div>
        @*<div class="chat__info-name">
                Nguyễn Minh Hiếu
            </div>*@
    <h2>@Model.CONVERSATION_DETAIL.Where(detail => (detail.ID_User == ViewBag.User_ID)).FirstOrDefault().Name</h2>
        <div class="form-close">
            <i class="far fa-times-circle"></i>
        </div>
    </div>
</div>
<div class="chat-area">
    <section class="chatbox">
        <section class="chat-window">
            @foreach (MESSAGE msg in Model.MESSAGEs.OrderBy(mess => mess.Time_sent))
            {
                if (msg.User_ID_Sent == ViewBag.User_ID)
                {
                    <article class="msg-container msg-self" id="@msg.Message_ID">
                        <div class="msg-box">
                            <div class="flr">
                                <div class="messages">
                                    <p class="msg">
                                        @msg.Message_text
                                    </p>
                                </div>
                                <div class="timestamp"><span class="posttime">@msg.Time_sent.ToString()</span></div>
                            </div>
                            <img class="user-img" src="@msg.ACCOUNT.Photos.Where(photo => photo.isAvatar == true).FirstOrDefault().Link" />
                        </div>
                    </article>
                }
                else
                {
                    <article class="msg-container msg-remote" id="@msg.Message_ID">
                        <div class="msg-box">
                            <img class="user-img" src="@msg.ACCOUNT.Photos.Where(photo => photo.isAvatar == true).FirstOrDefault().Link" />
                            <div class="flr">
                                <div class="messages">
                                    <p class="msg">
                                        @msg.Message_text
                                    </p>
                                </div>
                                <div class="timestamp"><span class="posttime">@msg.Time_sent.ToString()</span></div>
                            </div>
                        </div>
                    </article>
                }
            }
        </section>
    </section>
</div>
<form class="chat-input" onsubmit="return false;">
    <input id="message-text" type="text" autocomplete="on" placeholder="Type a message" style="max-width: 100%" />
    <button id="btnSend">
        <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="rgba(0,0,0,.38)" d="M17,12L12,17V14H8V10H12V7L17,12M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L5,8.09V15.91L12,19.85L19,15.91V8.09L12,4.15Z" /></svg>
    </button>
</form>
@*<script src="js/eventHomePage.js"></script>*@
<script>
    $(document).on('click', '.form-close', function () {
        $('.scroll-photos-area').html('')
        $.ajax({
            url: "/Velo/Photos/" + $('#id-user').val(),
        }).done(function (rs) {
            $('.scroll-photos-area').html(rs)
        }).fail(function (err) {
            console.log(err)
        })
    })
    //console.log($('.form-close'))
    $(function () {
        $('.chat-window').scrollTop($('.chat-window').get(0).scrollHeight);
        var chatHub = $.connection.chat;
        loadClient(chatHub);
        //khởi chạy connect hub
        $.connection.hub.start().done(function () {
            console.log('connected');
            //$("#btnLogin").click(function () {
            //    var name = $("#txtName").val();
            //    chatHub.server.connect(name);
            //    $('#welcome').html("Xin chao : " + name);
            //    show();
            //});

            $('#btnSend').click(function () {
                //var msg = $('#txtMessage').val();
                //var name = $('#hName').val();
                //chatHub.server.message(name, msg);
                //$('#txtMessage').val('').focus();
                var message = {
                    Conversation_ID: $('#conversation-id').val(),
                    User_ID_sent: $('#id-user').val(),
                    Message_text: $('#message-text').val(),
                    Time_sent: Date.now
                }
                var Message_ID = chatHub.server.message(JSON.stringify(message));
                console.log(Message_ID)
                message.Message_ID = Message_ID
                $('.chat-window').append(sendMessage(message))
                $('#message-text').val('')
                $('.chat-window').animate({
                    scrollTop: $('.chat-window').get(0).scrollHeight
                }, 200);
            });
        });
    })

    // load các ham bên phía client
    function loadClient(chatHub) {
        console.log('load event')
        chatHub.client.message = function (messageJSON) {
            //console.log('message.Conversation_ID ' + message.Conversation_ID)
            //$('#contentMsg').append("<li><strong>" + name + "</strong>: " + msg + "</li>");
            var message = JSON.parse(messageJSON)
            if (message.Conversation_ID === $('#conversation-id').val()) {
                $('.chat-window').append(receiveMessage(message))
                $('.chat-window').animate({
                    scrollTop: $('.chat-window').get(0).scrollHeight
                }, 200);
            }
        }
        chatHub.client.connect = function (name) {
            //$('#hName').val(name);
        }
    }

    function sendMessage(message) {
        //console.log(message)
        return `<article class="msg-container msg-self" id="${message.Message_ID}">
            <div class="msg-box">
                <div class="flr">
                    <div class="messages">
                        <p class="msg" id="msg-1">
                            ${message.Message_text}
                        </p>
                    </div>
                    <div class="timestamp"><span class="posttime">${message.Time_sent}</span></div>
                </div>
                <img class="user-img" src="${$('.personal-avatar').attr('src')}" />
            </div>
        </article>`
    }

    function receiveMessage(message) {
        console.log(message)
        return `<article class="msg-container msg-remote" id="${message.Message_ID}">
            <div class="msg-box">
                <img class="user-img" src="${$('.object-info-avatar').attr('src')}" />
                <div class="flr">
                    <div class="messages">
                        <p class="msg" id="msg-0">
                            ${message.Message_text}
                        </p>
                    </div>
                    <div class="timestamp"><span class="posttime">${message.Time_sent}</span></div>
                </div>
            </div>
        </article>`
    }
</script>
